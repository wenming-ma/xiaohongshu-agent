"""
å†…å®¹åˆ›ä½œ Agent
åŸºäºç ”ç©¶æ•°æ®ç”Ÿæˆå°çº¢ä¹¦å†…å®¹
"""
import os
from pydantic_ai import Agent
from ..models.schemas import ResearchResult, XHSContent


class ContentAgent:
    """å°çº¢ä¹¦å†…å®¹åˆ›ä½œ Agent"""

    def __init__(self, model: str = "claude-sonnet-4-20250514"):
        """
        åˆå§‹åŒ–å†…å®¹ Agent

        Args:
            model: ä½¿ç”¨çš„æ¨¡å‹åç§°
        """
        # ä»ç¯å¢ƒå˜é‡è·å– API Key
        api_key = os.getenv("ANTHROPIC_API_KEY")
        if not api_key:
            raise ValueError("ANTHROPIC_API_KEY ç¯å¢ƒå˜é‡æœªè®¾ç½®")

        self.agent = Agent(
            model=model,
            output_type=XHSContent,
            system_prompt=("""ä½ æ˜¯å°çº¢ä¹¦å†…å®¹åˆ›ä½œä¸“å®¶ã€‚

**åˆ›ä½œé£æ ¼**ï¼š
- çœŸå®ã€æ¥åœ°æ°”ã€æœ‰æ¸©åº¦
- æ•°æ®é©±åŠ¨ï¼ˆåŸºäºç ”ç©¶ç»“æœï¼‰
- å…·ä½“æ¡ˆä¾‹æ”¯æ’‘ï¼ˆä¸è¦ç©ºè¯å¥—è¯ï¼‰
- æ˜“è¯»ã€æœ‰æ¡ç†

**å†…å®¹è¦æ±‚**ï¼š

1. **æ ‡é¢˜** (15-20 å­—)ï¼š
   - å¿…é¡»åŒ…å« 1-2 ä¸ª emoji
   - å¸å¼•çœ¼çƒä½†ä¸å¤¸å¼ 
   - ä½“ç°æ ¸å¿ƒä»·å€¼
   - ä¾‹ï¼šğŸš¨è¥¿å®‰æ±‚èŒé¿å‘ï¼è¿™ 5 å®¶å…¬å¸è¦æ³¨æ„

2. **æ­£æ–‡** (200-500 å­—)ï¼š
   ç»“æ„ï¼š
   - å¼€å¤´ï¼šä¸€å¥è¯æ¦‚æ‹¬ï¼ˆå¸å¼•è¯»è€…ï¼‰
   - ä¸»ä½“ï¼šè‡³å°‘æåŠ 3 ä¸ªå…·ä½“å…¬å¸/æ¡ˆä¾‹
     * æ¯ä¸ªæ¡ˆä¾‹åŒ…å«ï¼šå…¬å¸å + é—®é¢˜ + ç»†èŠ‚
     * ä½¿ç”¨æ•°å­—ï¼ˆå¦‚ï¼š5 å®¶å…¬å¸ã€è¯•ç”¨æœŸ 3 ä¸ªæœˆï¼‰
   - ç»“å°¾ï¼šå»ºè®®æˆ–æé†’

   æ ¼å¼ï¼š
   - ä½¿ç”¨åºå·ï¼ˆ1ï¸âƒ£ 2ï¸âƒ£ 3ï¸âƒ£ æˆ– â‘ â‘¡â‘¢ï¼‰
   - é€‚å½“æ¢è¡Œï¼ˆæ¯ 2-3 å¥æ¢è¡Œï¼‰
   - å…³é”®ä¿¡æ¯ç”¨ã€Œã€æˆ–ã€ã€‘æ ‡æ³¨

3. **æ ‡ç­¾** (3-5 ä¸ª)ï¼š
   - ä¸ä¸»é¢˜é«˜åº¦ç›¸å…³
   - åŒ…å«åœ°åŸŸã€è¡Œä¸šã€æ ¸å¿ƒè¯
   - ä¾‹ï¼š#è¥¿å®‰æ±‚èŒ #é¿å‘æŒ‡å— #èŒåœºå¹²è´§

4. **è¡ŒåŠ¨å·å¬**ï¼š
   - å¼•å¯¼äº’åŠ¨ï¼ˆè¯„è®ºã€åˆ†äº«ï¼‰
   - ä¾‹ï¼šä½ è¿˜é‡åˆ°è¿‡å“ªäº›å‘ï¼Ÿè¯„è®ºåŒºåˆ†äº« ğŸ’¬

**ç¦å¿Œ**ï¼š
- âŒ ä¸è¦ç¼–é€ æ•°æ®æˆ–å…¬å¸å
- âŒ ä¸è¦ç©ºæ³›çš„å»ºè®®ï¼ˆ"è¦è°¨æ…é€‰æ‹©"ï¼‰
- âŒ ä¸è¦è´Ÿé¢æƒ…ç»ªè¿‡é‡
- âœ… åªä½¿ç”¨ç ”ç©¶æ•°æ®ä¸­çš„çœŸå®ä¿¡æ¯""",)
        )

    async def create_content(
        self,
        research: ResearchResult,
        topic: str
    ) -> XHSContent:
        """
        åˆ›ä½œå°çº¢ä¹¦å†…å®¹

        Args:
            research: ç ”ç©¶ç»“æœ
            topic: ä¸»é¢˜

        Returns:
            XHSContent: åˆ›ä½œçš„å†…å®¹
        """
        prompt = f"""
**åˆ›ä½œä»»åŠ¡**ï¼šåŸºäºç ”ç©¶æ•°æ®ï¼Œåˆ›ä½œå…³äº "{topic}" çš„å°çº¢ä¹¦å†…å®¹

**ç ”ç©¶æ•°æ®**ï¼š
```json
{research.model_dump_json(indent=2)}
```

**å…·ä½“è¦æ±‚**ï¼š

1. **æ ‡é¢˜**ï¼š
   - 15-20 å­—
   - åŒ…å« 1-2 ä¸ªç›¸å…³ emoji
   - å¸å¼•ç›®æ ‡å—ä¼—
   - ä½“ç°æ ¸å¿ƒä»·å€¼ï¼ˆé¿å‘/æ”»ç•¥/çœŸå®ç»å†ï¼‰

2. **æ­£æ–‡**ï¼š
   - å¼€å¤´ä¸€å¥è¯å¸å¼•è¯»è€…
   - ä¸»ä½“éƒ¨åˆ†ï¼š
     * ä» entities/cases ä¸­é€‰æ‹©è‡³å°‘ 3 ä¸ªå…·ä½“æ¡ˆä¾‹
     * æ¯ä¸ªæ¡ˆä¾‹åŒ…å«ï¼šå…¬å¸å + å…·ä½“é—®é¢˜ + ç»†èŠ‚
     * ä½¿ç”¨åºå·åˆ†ç‚¹ï¼ˆ1ï¸âƒ£ 2ï¸âƒ£ 3ï¸âƒ£ï¼‰
   - ç»“å°¾ç»™å‡ºå»ºè®®æˆ–æé†’

   æ ¼å¼ç¤ºä¾‹ï¼š
   ```
   æœ€è¿‘æ•´ç†äº†è¥¿å®‰ 10 å®¶å…¬å¸çš„çœŸå®é¿å‘ç»å†ï¼Œå¤ªæœ‰ç”¨äº†ï¼

   1ï¸âƒ£ ã€æŸç§‘æŠ€å…¬å¸ã€‘
   è¯•ç”¨æœŸä¸äº¤ç¤¾ä¿ï¼Œè½¬æ­£åå„ç§åŠ ç­ä¸ç»™åŠ ç­è´¹...

   2ï¸âƒ£ ã€æŸç½‘ç»œå…¬å¸ã€‘
   æ‰¿è¯ºé¡¹ç›®ææˆï¼Œç»“æœ...

   è®°ä½ï¼šå…¥èŒå‰ä¸€å®šè¦...
   ```

3. **æ ‡ç­¾**ï¼š
   - ä» keywords ä¸­é€‰æ‹© 3-5 ä¸ª
   - æ ¼å¼ï¼š#å…³é”®è¯

4. **è¡ŒåŠ¨å·å¬**ï¼š
   - å¼•å¯¼è¯„è®ºæˆ–åˆ†äº«
   - ä¾‹ï¼šä½ è¿˜é‡åˆ°è¿‡å“ªäº›å…¬å¸ï¼Ÿè¯„è®ºåŒºè¯´è¯´ ğŸ’¬

**åˆ›ä½œåŸåˆ™**ï¼š
- åªä½¿ç”¨ç ”ç©¶æ•°æ®ä¸­çš„çœŸå®ä¿¡æ¯
- ä¸ç¼–é€ ã€ä¸å¤¸å¤§
- å…·ä½“ > æ³›æ³›è€Œè°ˆ
- æœ‰æ¸©åº¦ã€æ¥åœ°æ°”

å¼€å§‹åˆ›ä½œï¼
"""

        print("   âœï¸  å¼€å§‹åˆ›ä½œå†…å®¹...")
        result = await self.agent.run(prompt)

        return result.output
